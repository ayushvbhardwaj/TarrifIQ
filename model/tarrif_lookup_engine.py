import pandas as pd

TARIFF_CSV = "/Users/ayushbhardwaj/Documents/TarrifIQ/data/tariffs_2025_clean.csv"


def load_tariffs(path: str = TARIFF_CSV) -> pd.DataFrame:
    """Load the cleaned tariff dataset."""
    return pd.read_csv(path, dtype={"hs_code": str})


def get_available_countries(hs_code: str, tariffs_df: pd.DataFrame) -> list[str]:
    """Return sorted list of countries that have a tariff for the given HS code."""
    hs_code = str(hs_code).zfill(6)
    matches = tariffs_df[tariffs_df["hs_code"] == hs_code]
    return sorted(matches["country"].unique().tolist())


def get_available_years(hs_code: str, country: str, tariffs_df: pd.DataFrame) -> list[int]:
    """Return sorted list of years available for a given HS code + country."""
    hs_code = str(hs_code).zfill(6)
    matches = tariffs_df[
        (tariffs_df["hs_code"] == hs_code) &
        (tariffs_df["country"] == country)
    ]
    return sorted(matches["year"].unique().tolist())


def get_tariff_rate(hs_code: str, country: str, year: int, tariffs_df: pd.DataFrame) -> float | None:
    """Look up the tariff rate (%) for a specific HS code + country + year."""
    hs_code = str(hs_code).zfill(6)
    row = tariffs_df[
        (tariffs_df["hs_code"] == hs_code) &
        (tariffs_df["country"] == country) &
        (tariffs_df["year"] == year)
    ]
    if row.empty:
        return None
    return float(row.iloc[0]["tariff_rate"])


def calculate_total_cost(hs_code: str, country: str, year: int,
                         base_cost: float, tariffs_df: pd.DataFrame) -> dict | None:
    """
    Calculate the total landed cost given a base cost and tariff.

    Returns a dict with:
        - tariff_rate  : the duty percentage
        - duty_amount  : base_cost × tariff_rate / 100
        - total_cost   : base_cost + duty_amount
    Returns None if no tariff is found.
    """
    rate = get_tariff_rate(hs_code, country, year, tariffs_df)
    if rate is None:
        return None

    duty = round(base_cost * rate / 100, 2)
    total = round(base_cost + duty, 2)
    return {
        "tariff_rate": rate,
        "duty_amount": duty,
        "total_cost": total,
    }


# ── Interactive CLI ─────────────────────────────────────────────────
if __name__ == "__main__":
    df = load_tariffs()

    # 1. HS code
    hs = input("Enter HS code: ").strip()

    # 2. Show available countries
    countries = get_available_countries(hs, df)
    if not countries:
        print(f"No tariff data found for HS code: {hs}")
        exit()

    print(f"\n{len(countries)} countries available for HS {hs}:")
    for i, c in enumerate(countries, 1):
        print(f"  {i}. {c}")

    choice = int(input("\nSelect country (number): ").strip())
    country = countries[choice - 1]

    # 3. Show available years
    years = get_available_years(hs, country, df)
    if len(years) == 1:
        year = years[0]
        print(f"\nOnly year available: {year}")
    else:
        print(f"\nAvailable years: {years}")
        year = int(input("Select year: ").strip())

    # 4. Get tariff rate
    rate = get_tariff_rate(hs, country, year, df)
    print(f"\nTariff rate for {country} | HS {hs} | {year}: {rate}%")

    # 5. Calculate total cost
    base = float(input("\nEnter base cost ($): ").strip())
    result = calculate_total_cost(hs, country, year, base, df)

    print(f"\n{'─' * 40}")
    print(f"  Base cost     : ${base:,.2f}")
    print(f"  Tariff rate   : {result['tariff_rate']}%")
    print(f"  Duty amount   : ${result['duty_amount']:,.2f}")
    print(f"  Total cost    : ${result['total_cost']:,.2f}")
    print(f"{'─' * 40}")
